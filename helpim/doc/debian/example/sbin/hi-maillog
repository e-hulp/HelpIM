# needs some variables:
# $chat (chat identifier)
# $issuer (name of the program sending the maillog)
# $mailto (where to send it to)

TMPFILE=‘mktemp‘

echo "$issuer report about $chat on `date`" > $TMPFILE

# mysqldump
echo "" >> $TMPFILE
echo "Mysqldump of room-tables:" >> $TMPFILE
DBNAME=`grep "DATABASES\['default'\]\['NAME'\]" /etc/helpim/sites/$chat/settings.py | cut -d "=" -f 2 | sed "s/'//g" | sed "s/ //g"`
DBUSER=`grep "DATABASES\['default'\]\['USER'\]" /etc/helpim/sites/$chat/settings.py | cut -d "=" -f 2 | sed "s/'//g" | sed "s/ //g"`
DBPASSWORD=`grep "DATABASES\['default'\]\['PASSWORD'\]" /etc/helpim/sites/$chat/settings.py | cut -d "=" -f 2 | sed "s/'//g" | sed "s/ //g"`
mysqldump -u $DBUSER -p$DBPASSWORD $DBNAME rooms_accesstoken rooms_grouproom rooms_lobbyroom \
 rooms_lobbyroomtoken rooms_one2oneroom rooms_one2oneroomtoken \
 rooms_waitingroom rooms_waitingroomtoken rooms_simpleroom rooms_simpleroomtoken >> $TMPFILE

# mail logfiles

for LOGFILE in /var/log/helpim/$chat.log /var/log/prosody/prosody.log /var/log/prosody/prosody.err
do
  echo "" >> $TMPFILE
  if [ -r "$LOGFILE" ] ; then
    echo "Last 250 lines of $LOGFILE:" >> $TMPFILE
    tail -n 250 $LOGFILE >> $TMPFILE
  else
    echo "Skipping $LOGFILE: No permission to read." >> $TMPFILE
  fi
done

cat $TMPFILE | mail -s "$issuer requested to mail logs of $chat" $mailto

rm $TMPFILE
TMPFILE=""
